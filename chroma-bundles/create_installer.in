#!/bin/sh -e

usage() {

    echo "Usage: $0 {zfs|ldiskfs}"
    exit 1
}

ldiskfs_installer() {
    local DISTRO=$1

    # create an installer for the user
    cat <<"EOF" > install
#!/bin/sh

yum -y install lustre-modules lustre lustre-osd-ldiskfs
       lustre-osd-ldiskfs-mount e2fsprogs e2fsprogs-devel
       libcom_err-devel kernel-headers kernel-devel
       e2fsprogs-libs libcom_err libss

echo "You need to reboot to activate the Lustre kernel"

EOF

}

zfs_installer() {
    local DISTRO=$1

    ZFS_VERSION=@ZFS_VERSION@

    # create an installer for the user
    cat <<EOF > install
#!/bin/sh

yum -y install dkms \
               zfs-dkms spl-dkms \
               lustre-dkms lustre-osd-zfs \
               lustre-osd-zfs-mount lustre \
               kernel-devel-\$(uname -r) kernel-headers-\$(uname -r) \
               spl \
               libnvpair1 \
               libuutil1 \
               libzfs2 \
               libzpool2 \
               zfs
EOF

}

case $1 in
    zfs|ldiskfs)
        BACKING_STORE="$1"
    ;;
    *) usage
    ;;
esac

for DISTRO in el6 el7; do
    if [ ! -d $DISTRO ]; then
        continue
    fi
    rm -rf lustre-$BACKING_STORE
    mkdir -p lustre-$BACKING_STORE

    # arrange for cleanup of the dir on exit for any reason
    trap "rm -rf lustre-$BACKING_STORE" EXIT
    
    cd lustre-$BACKING_STORE

    ${1}_installer "$DISTRO"

    chmod 755 install
    cd ..

    tar czf lustre-$BACKING_STORE-$DISTRO-installer.tar.gz lustre-$BACKING_STORE
done
